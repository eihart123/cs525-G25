/**
 * @license
 * Copyright 2022-2025 Matter.js Authors
 * SPDX-License-Identifier: Apache-2.0
 */
import { build as esbuild } from "esbuild";
import { cp, mkdir, readFile, rm, symlink, writeFile } from "node:fs/promises";
import { platform } from "node:os";
import { dirname, join } from "node:path";
import { ignoreError } from "../util/errors.js";
import { CONFIG_PATH, Package } from "../util/package.js";
const BUILD_INFO_LOCATION = "build/info.json";
const COMPILED_CONFIG_PATH = "build/build.config.js";
class Project {
  pkg;
  #config;
  #configured;
  constructor(source = ".") {
    if (typeof source === "string") {
      this.pkg = new Package({ path: source });
    } else {
      this.pkg = source;
    }
    if (!this.pkg.hasSrc) {
      throw new Error(
        `Found package ${this.pkg.json.name} but src directory is not present or not referenced in tsconfig.json`
      );
    }
  }
  async buildSource(format) {
    await this.#build(format, "src", `dist/${format}`);
    await this.#configureFormat("dist", format, true);
  }
  async buildTests(format) {
    if (this.pkg.hasDirectory("test")) {
      await this.#build(format, "test", `build/${format}/test`);
    }
    const src = `dist/${format}`;
    const dest = `build/${format}/src`;
    try {
      const destPath = this.pkg.resolve(dest);
      await mkdir(dirname(destPath), { recursive: true });
      await ignoreError("EEXIST", async () => await symlink(this.pkg.resolve(src), destPath));
    } catch (e) {
      if (e.code === "EPERM" && platform() === "win32") {
        await cp(this.pkg.resolve(src), this.pkg.resolve(dest), {
          recursive: true,
          force: true
        });
      } else {
        throw e;
      }
    }
    await this.#configureFormat("build", format, false);
  }
  async clean() {
    for (const dir of ["build", "dist"]) {
      await rm(this.pkg.resolve(dir), { recursive: true, force: true });
    }
  }
  get hasDeclarations() {
    return this.pkg.hasDirectory("build/types");
  }
  async hashDeclarations(apiSha) {
    if (!this.pkg.isLibrary) {
      return;
    }
    let path;
    if (this.pkg.supportsEsm) {
      path = "esm";
    } else if (this.pkg.supportsCjs) {
      path = "cjs";
    } else {
      return;
    }
    const declarations = (await this.pkg.glob(`dist/${path}/**/*.d.{ts,mts,cts}`)).sort();
    for (const file of declarations) {
      apiSha.update(file);
      apiSha.update(await readFile(file));
    }
  }
  async recordBuildInfo(info) {
    await mkdir(this.pkg.resolve("build"), { recursive: true });
    info.timestamp = (/* @__PURE__ */ new Date()).toISOString();
    await writeFile(this.pkg.resolve(BUILD_INFO_LOCATION), JSON.stringify(info, void 0, 4));
  }
  async configure() {
    if (this.#configured) {
      return this.#config;
    }
    if (!this.pkg.hasConfig) {
      return {};
    }
    const configPath = this.pkg.resolve(CONFIG_PATH);
    const outfile = this.pkg.resolve(COMPILED_CONFIG_PATH).replaceAll("\\", "/");
    await esbuild({
      entryPoints: [configPath],
      outfile,
      sourcemap: true
    });
    this.#config = await import(`file://${outfile}`);
    this.#configured = true;
    if (this.#config?.startup) {
      await this.#config?.startup({
        project: this
      });
    }
    return this.#config;
  }
  /**
   * Copy files into dist for supported formats.
   */
  async copyToDist(source, dest) {
    const formats = Array();
    if (this.pkg.supportsEsm) {
      formats.push("esm");
    }
    if (this.pkg.supportsCjs) {
      formats.push("cjs");
    }
    for (const format of formats) {
      await cp(this.pkg.resolve(source), this.pkg.resolve(join("dist", format, dest)), {
        recursive: true,
        force: true
      });
    }
  }
  async #build(format, indir, outdir) {
    const entryPoints = await this.#targetsOf(indir, outdir, "ts", "js");
    const configPath = this.pkg.resolve(CONFIG_PATH);
    for (const entry of entryPoints) {
      if (entry.in === configPath) {
        continue;
      }
      entry.out = entry.out.replace(/\.[jt]s$/, "");
    }
    await esbuild({
      entryPoints,
      outdir: this.pkg.path,
      format,
      sourcemap: true,
      sourcesContent: false,
      absWorkingDir: dirname(this.pkg.resolve(indir)),
      // This is necessary to downlevel "using"
      target: "es2022",
      logOverride: {
        "direct-eval": "silent"
      }
    });
    for (const entry of await this.#targetsOf(indir, outdir, "cjs", "mjs", "d.cts", "d.mts")) {
      await cp(entry.in, entry.out);
    }
  }
  async #configureFormat(dir, format, isDist) {
    let { imports } = this.pkg.json;
    if (isDist && typeof imports === "object") {
      imports = { ...imports };
      for (const key in imports) {
        const value = imports[key];
        if (typeof value === "string") {
          imports[key] = value.replace(/^\.\/src\//, "./");
        }
      }
    }
    const path = this.pkg.resolve(`${dir}/${format}/package.json`);
    const json = {
      type: format === "cjs" ? "commonjs" : "module",
      imports
    };
    await writeFile(path, JSON.stringify(json, void 0, 4));
  }
  async #targetsOf(indir, outdir, ...extensions) {
    const inputPrefixLength = this.pkg.resolve(indir).length + 1;
    outdir = this.pkg.resolve(outdir).replace(/\\/g, "/");
    return (await this.pkg.glob(extensions.map((ext) => `${indir}/**/*.${ext}`))).map((file) => ({
      in: file,
      out: `${outdir}/${file.slice(inputPrefixLength)}`
    }));
  }
}
export {
  BUILD_INFO_LOCATION,
  COMPILED_CONFIG_PATH,
  Project
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vLi4vc3JjL2J1aWxkaW5nL3Byb2plY3QudHMiXSwKICAic291cmNlc0NvbnRlbnQiOiBbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDIyLTIwMjUgTWF0dGVyLmpzIEF1dGhvcnNcbiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wXG4gKi9cblxuaW1wb3J0IHsgYnVpbGQgYXMgZXNidWlsZCwgRm9ybWF0IH0gZnJvbSBcImVzYnVpbGRcIjtcbmltcG9ydCB7IEhhc2ggfSBmcm9tIFwibm9kZTpjcnlwdG9cIjtcbmltcG9ydCB7IGNwLCBta2RpciwgcmVhZEZpbGUsIHJtLCBzeW1saW5rLCB3cml0ZUZpbGUgfSBmcm9tIFwibm9kZTpmcy9wcm9taXNlc1wiO1xuaW1wb3J0IHsgcGxhdGZvcm0gfSBmcm9tIFwibm9kZTpvc1wiO1xuaW1wb3J0IHsgZGlybmFtZSwgam9pbiB9IGZyb20gXCJub2RlOnBhdGhcIjtcbmltcG9ydCB7IGlnbm9yZUVycm9yIH0gZnJvbSBcIi4uL3V0aWwvZXJyb3JzLmpzXCI7XG5pbXBvcnQgeyBDT05GSUdfUEFUSCwgUGFja2FnZSB9IGZyb20gXCIuLi91dGlsL3BhY2thZ2UuanNcIjtcblxuZXhwb3J0IGNvbnN0IEJVSUxEX0lORk9fTE9DQVRJT04gPSBcImJ1aWxkL2luZm8uanNvblwiO1xuZXhwb3J0IGNvbnN0IENPTVBJTEVEX0NPTkZJR19QQVRIID0gXCJidWlsZC9idWlsZC5jb25maWcuanNcIjtcblxuZXhwb3J0IGludGVyZmFjZSBCdWlsZEluZm9ybWF0aW9uIHtcbiAgICAvKipcbiAgICAgKiBUaW1lIG9mIGxhc3QgYnVpbGQuICBDb21wYXJlZCB0byBzb3VyY2UgZmlsZXMgdG8gZGV0ZXJtaW5lIHdoZXRoZXIgYnVpbGQgaXMgZGlydHkuXG4gICAgICovXG4gICAgdGltZXN0YW1wPzogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICogQVBJIHNpZ25hdHVyZS4gIFVzZWQgYnkgZGVwZW5kZW50cyB0byBkZXRlcm1pbmUgd2hldGhlciB0aGV5IG5lZWQgdG8gcmVidWlsZCBhZnRlciB3ZSBkby5cbiAgICAgKi9cbiAgICBhcGlTaGE/OiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBBUEkgc2lnbmF0dXJlIG9mIGVhY2ggZGVwZW5kZW5jeS4gIENvbXBhcmVkIHRvIGFwaVNoYSBvZiBlYWNoIGRlcGVuZGVuY3kgZHVyaW5nIGRpcnR5IGRldGVjdGlvbi5cbiAgICAgKi9cbiAgICBkZXBlbmRlbmN5QXBpU2hhcz86IFJlY29yZDxzdHJpbmcsIHN0cmluZz47XG59XG5cbmV4cG9ydCBjbGFzcyBQcm9qZWN0IHtcbiAgICBwa2c6IFBhY2thZ2U7XG4gICAgI2NvbmZpZz86IFByb2plY3QuQ29uZmlnO1xuICAgICNjb25maWd1cmVkPzogYm9vbGVhbjtcblxuICAgIGNvbnN0cnVjdG9yKHNvdXJjZTogUGFja2FnZSB8IHN0cmluZyA9IFwiLlwiKSB7XG4gICAgICAgIGlmICh0eXBlb2Ygc291cmNlID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgICB0aGlzLnBrZyA9IG5ldyBQYWNrYWdlKHsgcGF0aDogc291cmNlIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5wa2cgPSBzb3VyY2U7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXRoaXMucGtnLmhhc1NyYykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgICAgIGBGb3VuZCBwYWNrYWdlICR7dGhpcy5wa2cuanNvbi5uYW1lfSBidXQgc3JjIGRpcmVjdG9yeSBpcyBub3QgcHJlc2VudCBvciBub3QgcmVmZXJlbmNlZCBpbiB0c2NvbmZpZy5qc29uYCxcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBidWlsZFNvdXJjZShmb3JtYXQ6IEZvcm1hdCkge1xuICAgICAgICBhd2FpdCB0aGlzLiNidWlsZChmb3JtYXQsIFwic3JjXCIsIGBkaXN0LyR7Zm9ybWF0fWApO1xuICAgICAgICBhd2FpdCB0aGlzLiNjb25maWd1cmVGb3JtYXQoXCJkaXN0XCIsIGZvcm1hdCwgdHJ1ZSk7XG4gICAgfVxuXG4gICAgYXN5bmMgYnVpbGRUZXN0cyhmb3JtYXQ6IEZvcm1hdCkge1xuICAgICAgICBpZiAodGhpcy5wa2cuaGFzRGlyZWN0b3J5KFwidGVzdFwiKSkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy4jYnVpbGQoZm9ybWF0LCBcInRlc3RcIiwgYGJ1aWxkLyR7Zm9ybWF0fS90ZXN0YCk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzcmMgPSBgZGlzdC8ke2Zvcm1hdH1gO1xuICAgICAgICBjb25zdCBkZXN0ID0gYGJ1aWxkLyR7Zm9ybWF0fS9zcmNgO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBkZXN0UGF0aCA9IHRoaXMucGtnLnJlc29sdmUoZGVzdCk7XG4gICAgICAgICAgICBhd2FpdCBta2RpcihkaXJuYW1lKGRlc3RQYXRoKSwgeyByZWN1cnNpdmU6IHRydWUgfSk7XG4gICAgICAgICAgICBhd2FpdCBpZ25vcmVFcnJvcihcIkVFWElTVFwiLCBhc3luYyAoKSA9PiBhd2FpdCBzeW1saW5rKHRoaXMucGtnLnJlc29sdmUoc3JjKSwgZGVzdFBhdGgpKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgaWYgKChlIGFzIGFueSkuY29kZSA9PT0gXCJFUEVSTVwiICYmIHBsYXRmb3JtKCkgPT09IFwid2luMzJcIikge1xuICAgICAgICAgICAgICAgIC8vIElmIGRldmVsb3BlciBtb2RlIGlzIG5vdCBlbmFibGVkLCB3ZSBjYW4ndCBjcmVhdGUgYSBzeW1saW5rXG4gICAgICAgICAgICAgICAgLy8gb24gV2luZG93cy4gIENvcHkgaW5zdGVhZFxuICAgICAgICAgICAgICAgIGF3YWl0IGNwKHRoaXMucGtnLnJlc29sdmUoc3JjKSwgdGhpcy5wa2cucmVzb2x2ZShkZXN0KSwge1xuICAgICAgICAgICAgICAgICAgICByZWN1cnNpdmU6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIGZvcmNlOiB0cnVlLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGF3YWl0IHRoaXMuI2NvbmZpZ3VyZUZvcm1hdChcImJ1aWxkXCIsIGZvcm1hdCwgZmFsc2UpO1xuICAgIH1cblxuICAgIGFzeW5jIGNsZWFuKCkge1xuICAgICAgICBmb3IgKGNvbnN0IGRpciBvZiBbXCJidWlsZFwiLCBcImRpc3RcIl0pIHtcbiAgICAgICAgICAgIGF3YWl0IHJtKHRoaXMucGtnLnJlc29sdmUoZGlyKSwgeyByZWN1cnNpdmU6IHRydWUsIGZvcmNlOiB0cnVlIH0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZ2V0IGhhc0RlY2xhcmF0aW9ucygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucGtnLmhhc0RpcmVjdG9yeShcImJ1aWxkL3R5cGVzXCIpO1xuICAgIH1cblxuICAgIGFzeW5jIGhhc2hEZWNsYXJhdGlvbnMoYXBpU2hhOiBIYXNoKSB7XG4gICAgICAgIGlmICghdGhpcy5wa2cuaXNMaWJyYXJ5KSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgcGF0aDtcbiAgICAgICAgaWYgKHRoaXMucGtnLnN1cHBvcnRzRXNtKSB7XG4gICAgICAgICAgICBwYXRoID0gXCJlc21cIjtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLnBrZy5zdXBwb3J0c0Nqcykge1xuICAgICAgICAgICAgcGF0aCA9IFwiY2pzXCI7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBkZWNsYXJhdGlvbnMgPSAoYXdhaXQgdGhpcy5wa2cuZ2xvYihgZGlzdC8ke3BhdGh9LyoqLyouZC57dHMsbXRzLGN0c31gKSkuc29ydCgpO1xuICAgICAgICBmb3IgKGNvbnN0IGZpbGUgb2YgZGVjbGFyYXRpb25zKSB7XG4gICAgICAgICAgICBhcGlTaGEudXBkYXRlKGZpbGUpO1xuICAgICAgICAgICAgYXBpU2hhLnVwZGF0ZShhd2FpdCByZWFkRmlsZShmaWxlKSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyByZWNvcmRCdWlsZEluZm8oaW5mbzogQnVpbGRJbmZvcm1hdGlvbikge1xuICAgICAgICBhd2FpdCBta2Rpcih0aGlzLnBrZy5yZXNvbHZlKFwiYnVpbGRcIiksIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuICAgICAgICBpbmZvLnRpbWVzdGFtcCA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTtcbiAgICAgICAgYXdhaXQgd3JpdGVGaWxlKHRoaXMucGtnLnJlc29sdmUoQlVJTERfSU5GT19MT0NBVElPTiksIEpTT04uc3RyaW5naWZ5KGluZm8sIHVuZGVmaW5lZCwgNCkpO1xuICAgIH1cblxuICAgIGFzeW5jIGNvbmZpZ3VyZSgpIHtcbiAgICAgICAgaWYgKHRoaXMuI2NvbmZpZ3VyZWQpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLiNjb25maWc7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXRoaXMucGtnLmhhc0NvbmZpZykge1xuICAgICAgICAgICAgcmV0dXJuIHt9O1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY29uZmlnUGF0aCA9IHRoaXMucGtnLnJlc29sdmUoQ09ORklHX1BBVEgpO1xuICAgICAgICBjb25zdCBvdXRmaWxlID0gdGhpcy5wa2cucmVzb2x2ZShDT01QSUxFRF9DT05GSUdfUEFUSCkucmVwbGFjZUFsbChcIlxcXFxcIiwgXCIvXCIpO1xuXG4gICAgICAgIGF3YWl0IGVzYnVpbGQoe1xuICAgICAgICAgICAgZW50cnlQb2ludHM6IFtjb25maWdQYXRoXSxcbiAgICAgICAgICAgIG91dGZpbGUsXG4gICAgICAgICAgICBzb3VyY2VtYXA6IHRydWUsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuI2NvbmZpZyA9IChhd2FpdCBpbXBvcnQoYGZpbGU6Ly8ke291dGZpbGV9YCkpIGFzIFByb2plY3QuQ29uZmlnIHwgdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLiNjb25maWd1cmVkID0gdHJ1ZTtcblxuICAgICAgICBpZiAodGhpcy4jY29uZmlnPy5zdGFydHVwKSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLiNjb25maWc/LnN0YXJ0dXAoe1xuICAgICAgICAgICAgICAgIHByb2plY3Q6IHRoaXMsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLiNjb25maWc7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ29weSBmaWxlcyBpbnRvIGRpc3QgZm9yIHN1cHBvcnRlZCBmb3JtYXRzLlxuICAgICAqL1xuICAgIGFzeW5jIGNvcHlUb0Rpc3Qoc291cmNlOiBzdHJpbmcsIGRlc3Q6IHN0cmluZykge1xuICAgICAgICBjb25zdCBmb3JtYXRzID0gQXJyYXk8c3RyaW5nPigpO1xuICAgICAgICBpZiAodGhpcy5wa2cuc3VwcG9ydHNFc20pIHtcbiAgICAgICAgICAgIGZvcm1hdHMucHVzaChcImVzbVwiKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5wa2cuc3VwcG9ydHNDanMpIHtcbiAgICAgICAgICAgIGZvcm1hdHMucHVzaChcImNqc1wiKTtcbiAgICAgICAgfVxuICAgICAgICBmb3IgKGNvbnN0IGZvcm1hdCBvZiBmb3JtYXRzKSB7XG4gICAgICAgICAgICBhd2FpdCBjcCh0aGlzLnBrZy5yZXNvbHZlKHNvdXJjZSksIHRoaXMucGtnLnJlc29sdmUoam9pbihcImRpc3RcIiwgZm9ybWF0LCBkZXN0KSksIHtcbiAgICAgICAgICAgICAgICByZWN1cnNpdmU6IHRydWUsXG4gICAgICAgICAgICAgICAgZm9yY2U6IHRydWUsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jICNidWlsZChmb3JtYXQ6IEZvcm1hdCwgaW5kaXI6IHN0cmluZywgb3V0ZGlyOiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3QgZW50cnlQb2ludHMgPSBhd2FpdCB0aGlzLiN0YXJnZXRzT2YoaW5kaXIsIG91dGRpciwgXCJ0c1wiLCBcImpzXCIpO1xuXG4gICAgICAgIGNvbnN0IGNvbmZpZ1BhdGggPSB0aGlzLnBrZy5yZXNvbHZlKENPTkZJR19QQVRIKTtcbiAgICAgICAgZm9yIChjb25zdCBlbnRyeSBvZiBlbnRyeVBvaW50cykge1xuICAgICAgICAgICAgaWYgKGVudHJ5LmluID09PSBjb25maWdQYXRoKSB7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbnRyeS5vdXQgPSBlbnRyeS5vdXQucmVwbGFjZSgvXFwuW2p0XXMkLywgXCJcIik7XG4gICAgICAgIH1cblxuICAgICAgICBhd2FpdCBlc2J1aWxkKHtcbiAgICAgICAgICAgIGVudHJ5UG9pbnRzLFxuICAgICAgICAgICAgb3V0ZGlyOiB0aGlzLnBrZy5wYXRoLFxuICAgICAgICAgICAgZm9ybWF0LFxuICAgICAgICAgICAgc291cmNlbWFwOiB0cnVlLFxuICAgICAgICAgICAgc291cmNlc0NvbnRlbnQ6IGZhbHNlLFxuICAgICAgICAgICAgYWJzV29ya2luZ0RpcjogZGlybmFtZSh0aGlzLnBrZy5yZXNvbHZlKGluZGlyKSksXG5cbiAgICAgICAgICAgIC8vIFRoaXMgaXMgbmVjZXNzYXJ5IHRvIGRvd25sZXZlbCBcInVzaW5nXCJcbiAgICAgICAgICAgIHRhcmdldDogXCJlczIwMjJcIixcblxuICAgICAgICAgICAgbG9nT3ZlcnJpZGU6IHtcbiAgICAgICAgICAgICAgICBcImRpcmVjdC1ldmFsXCI6IFwic2lsZW50XCIsXG4gICAgICAgICAgICB9LFxuICAgICAgICB9KTtcblxuICAgICAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIGF3YWl0IHRoaXMuI3RhcmdldHNPZihpbmRpciwgb3V0ZGlyLCBcImNqc1wiLCBcIm1qc1wiLCBcImQuY3RzXCIsIFwiZC5tdHNcIikpIHtcbiAgICAgICAgICAgIGF3YWl0IGNwKGVudHJ5LmluLCBlbnRyeS5vdXQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgI2NvbmZpZ3VyZUZvcm1hdChkaXI6IHN0cmluZywgZm9ybWF0OiBGb3JtYXQsIGlzRGlzdDogYm9vbGVhbikge1xuICAgICAgICAvLyBCdWlsZCBpbXBvcnQgbWFwXG4gICAgICAgIGxldCB7IGltcG9ydHMgfSA9IHRoaXMucGtnLmpzb247XG4gICAgICAgIGlmIChpc0Rpc3QgJiYgdHlwZW9mIGltcG9ydHMgPT09IFwib2JqZWN0XCIpIHtcbiAgICAgICAgICAgIGltcG9ydHMgPSB7IC4uLmltcG9ydHMgfTtcbiAgICAgICAgICAgIGZvciAoY29uc3Qga2V5IGluIGltcG9ydHMpIHtcbiAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IGltcG9ydHNba2V5XTtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgICAgICAgICAgIGltcG9ydHNba2V5XSA9IHZhbHVlLnJlcGxhY2UoL15cXC5cXC9zcmNcXC8vLCBcIi4vXCIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFdyaXRlIHBhY2thZ2UuanNvblxuICAgICAgICBjb25zdCBwYXRoID0gdGhpcy5wa2cucmVzb2x2ZShgJHtkaXJ9LyR7Zm9ybWF0fS9wYWNrYWdlLmpzb25gKTtcbiAgICAgICAgY29uc3QganNvbjogUmVjb3JkPHN0cmluZywgdW5rbm93bj4gPSB7XG4gICAgICAgICAgICB0eXBlOiBmb3JtYXQgPT09IFwiY2pzXCIgPyBcImNvbW1vbmpzXCIgOiBcIm1vZHVsZVwiLFxuICAgICAgICAgICAgaW1wb3J0cyxcbiAgICAgICAgfTtcbiAgICAgICAgYXdhaXQgd3JpdGVGaWxlKHBhdGgsIEpTT04uc3RyaW5naWZ5KGpzb24sIHVuZGVmaW5lZCwgNCkpO1xuICAgIH1cblxuICAgIGFzeW5jICN0YXJnZXRzT2YoaW5kaXI6IHN0cmluZywgb3V0ZGlyOiBzdHJpbmcsIC4uLmV4dGVuc2lvbnM6IHN0cmluZ1tdKSB7XG4gICAgICAgIGNvbnN0IGlucHV0UHJlZml4TGVuZ3RoID0gdGhpcy5wa2cucmVzb2x2ZShpbmRpcikubGVuZ3RoICsgMTtcbiAgICAgICAgb3V0ZGlyID0gdGhpcy5wa2cucmVzb2x2ZShvdXRkaXIpLnJlcGxhY2UoL1xcXFwvZywgXCIvXCIpO1xuXG4gICAgICAgIHJldHVybiAoYXdhaXQgdGhpcy5wa2cuZ2xvYihleHRlbnNpb25zLm1hcChleHQgPT4gYCR7aW5kaXJ9LyoqLyouJHtleHR9YCkpKS5tYXAoZmlsZSA9PiAoe1xuICAgICAgICAgICAgaW46IGZpbGUsXG4gICAgICAgICAgICBvdXQ6IGAke291dGRpcn0vJHtmaWxlLnNsaWNlKGlucHV0UHJlZml4TGVuZ3RoKX1gLFxuICAgICAgICB9KSk7XG4gICAgfVxufVxuXG5leHBvcnQgbmFtZXNwYWNlIFByb2plY3Qge1xuICAgIGV4cG9ydCBpbnRlcmZhY2UgQ29udGV4dCB7XG4gICAgICAgIHByb2plY3Q6IFByb2plY3Q7XG4gICAgfVxuXG4gICAgZXhwb3J0IGludGVyZmFjZSBDb25maWcge1xuICAgICAgICBzdGFydHVwPzogKGNvbnRleHQ6IENvbnRleHQpID0+IFByb21pc2U8dm9pZD47XG4gICAgICAgIGJlZm9yZT86IChjb250ZXh0OiBDb250ZXh0KSA9PiBQcm9taXNlPHZvaWQ+O1xuICAgICAgICBhZnRlcj86IChjb250ZXh0OiBDb250ZXh0KSA9PiBQcm9taXNlPHZvaWQ+O1xuICAgIH1cbn1cbiJdLAogICJtYXBwaW5ncyI6ICJBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFNQSxTQUFTLFNBQVMsZUFBdUI7QUFFekMsU0FBUyxJQUFJLE9BQU8s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
