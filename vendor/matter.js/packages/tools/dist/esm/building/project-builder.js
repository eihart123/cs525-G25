/**
 * @license
 * Copyright 2022-2025 Matter.js Authors
 * SPDX-License-Identifier: Apache-2.0
 */
import { createHash } from "node:crypto";
import { BuildError } from "./error.js";
import { Graph } from "./graph.js";
import { createTypescriptContext } from "./typescript.js";
var Target = /* @__PURE__ */ ((Target2) => {
  Target2["clean"] = "clean";
  Target2["types"] = "types";
  Target2["esm"] = "esm";
  Target2["cjs"] = "cjs";
  return Target2;
})(Target || {});
class ProjectBuilder {
  constructor(options = {}) {
    this.options = options;
    this.graph = options.graph;
    this.unconditional = options.clean || options.targets !== void 0 && options.targets?.indexOf("clean" /* clean */) !== -1;
  }
  unconditional;
  tsContext;
  graph;
  get hasClean() {
    return this.options.clean;
  }
  clearClean() {
    delete this.options.clean;
  }
  hasTargets() {
    return this.options.targets && this.options.targets.length > 0;
  }
  async configure(project) {
    if (!project.pkg.hasConfig) {
      return;
    }
    await project.configure();
  }
  async build(project) {
    const progress = project.pkg.start("Building");
    try {
      await this.#doBuild(project, progress);
    } catch (e) {
      progress.close();
      process.stderr.write(`${e.stack ?? e.message}

`);
      process.exit(1);
    }
    progress.close();
  }
  async #doBuild(project, progress) {
    const targets = this.#selectTargets(project);
    if (targets.has("clean" /* clean */) || this.options.clean) {
      await progress.run("Clean", () => project.clean());
    }
    if (!targets.has("types" /* types */) && !targets.has("esm" /* esm */) && !targets.has("cjs" /* cjs */)) {
      return;
    }
    const info = {};
    const config = await project.configure();
    await config?.before?.({ project });
    const graph = this.graph ?? await Graph.forProject(project.pkg.path);
    let node;
    if (graph) {
      node = graph.get(project.pkg.name);
      for (const dep of node.dependencies) {
        if (dep.info.apiSha !== void 0) {
          if (info.dependencyApiShas === void 0) {
            info.dependencyApiShas = {};
          }
          info.dependencyApiShas[dep.pkg.name] = dep.info.apiSha;
        }
      }
    }
    if (targets.has("types" /* types */)) {
      try {
        let context = this.tsContext;
        if (context === void 0) {
          context = this.tsContext = await createTypescriptContext(project.pkg.workspace, graph);
        }
        const refreshCallback = progress.refresh.bind(progress);
        if (project.pkg.isLibrary) {
          const apiSha = createHash("sha1");
          if (node) {
            for (const dep of node.dependencies) {
              if (dep.info.apiSha !== void 0) {
                apiSha.update(dep.info.apiSha);
              }
            }
          }
          await progress.run(`Generate ${progress.emphasize("type declarations")}`, async () => {
            await context.build(project.pkg, "src", refreshCallback);
            await project.hashDeclarations(apiSha);
          });
          info.apiSha = apiSha.digest("hex");
        } else {
          await progress.run(
            `Validate ${progress.emphasize("types")}`,
            () => context.build(project.pkg, "src", refreshCallback, false)
          );
        }
        if (project.pkg.hasTests) {
          await progress.run(
            `Validate ${progress.emphasize("test types")}`,
            () => context.build(project.pkg, "test", refreshCallback)
          );
        }
      } catch (e) {
        if (e instanceof BuildError) {
          progress.failure("Terminating due to type errors");
          process.stderr.write(`${e.diagnostics}
`);
          process.exit(1);
        }
        throw e;
      }
    }
    const formats = Array();
    if (targets.has("esm" /* esm */)) {
      formats.push("esm");
    }
    if (targets.has("cjs" /* cjs */)) {
      formats.push("cjs");
    }
    if (formats.length) {
      const groups = [project.pkg.isLibrary ? "library" : "app"];
      if (project.pkg.hasTests) {
        groups.push("tests");
      }
      const formatDesc = formats.map(progress.emphasize).join("+");
      const groupDesc = groups.map(progress.emphasize).join("+");
      await progress.run(`Transpile ${groupDesc} to ${formatDesc}`, async () => {
        for (const format of formats) {
          await this.#transpile(project, format);
        }
      });
    }
    await config?.after?.({ project });
    if (!this.options.targets?.length) {
      await project.recordBuildInfo(info);
      if (node) {
        node.info = info;
      }
    }
  }
  async #transpile(project, format) {
    await project.buildSource(format);
    if (project.pkg.hasTests) {
      await project.buildTests(format);
    }
  }
  #selectTargets(project) {
    const targets = new Set(this.options.targets);
    if (!targets.size) {
      targets.add("types" /* types */);
      if (project.pkg.supportsEsm) {
        targets.add("esm" /* esm */);
      }
      if (project.pkg.supportsCjs) {
        targets.add("cjs" /* cjs */);
      }
    } else {
      if (!project.pkg.supportsEsm) {
        targets.delete("esm" /* esm */);
      }
      if (!project.pkg.supportsCjs) {
        targets.delete("cjs" /* cjs */);
      }
    }
    return targets;
  }
}
export {
  ProjectBuilder,
  Target
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vLi4vc3JjL2J1aWxkaW5nL3Byb2plY3QtYnVpbGRlci50cyJdLAogICJzb3VyY2VzQ29udGVudCI6IFsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMjItMjAyNSBNYXR0ZXIuanMgQXV0aG9yc1xuICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjBcbiAqL1xuXG5pbXBvcnQgeyBjcmVhdGVIYXNoIH0gZnJvbSBcIm5vZGU6Y3J5cHRvXCI7XG5pbXBvcnQgeyBQcm9ncmVzcyB9IGZyb20gXCIuLi91dGlsL3Byb2dyZXNzLmpzXCI7XG5pbXBvcnQgeyBCdWlsZEVycm9yIH0gZnJvbSBcIi4vZXJyb3IuanNcIjtcbmltcG9ydCB7IEdyYXBoIH0gZnJvbSBcIi4vZ3JhcGguanNcIjtcbmltcG9ydCB7IEJ1aWxkSW5mb3JtYXRpb24sIFByb2plY3QgfSBmcm9tIFwiLi9wcm9qZWN0LmpzXCI7XG5pbXBvcnQgeyBjcmVhdGVUeXBlc2NyaXB0Q29udGV4dCB9IGZyb20gXCIuL3R5cGVzY3JpcHQuanNcIjtcbmltcG9ydCB7IFR5cGVzY3JpcHRDb250ZXh0IH0gZnJvbSBcIi4vdHlwZXNjcmlwdC9jb250ZXh0LmpzXCI7XG5cbmV4cG9ydCBlbnVtIFRhcmdldCB7XG4gICAgY2xlYW4gPSBcImNsZWFuXCIsXG4gICAgdHlwZXMgPSBcInR5cGVzXCIsXG4gICAgZXNtID0gXCJlc21cIixcbiAgICBjanMgPSBcImNqc1wiLFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIE9wdGlvbnMge1xuICAgIHRhcmdldHM/OiBUYXJnZXRbXTtcbiAgICBjbGVhbj86IGJvb2xlYW47XG4gICAgZ3JhcGg/OiBHcmFwaDtcbn1cblxuLyoqXG4gKiBIaWdoLWxldmVsIGJ1aWxkIGNvb3JkaW5hdGlvbi5cbiAqXG4gKiBXYXJuaW5nOiBUaGlzIGNsYXNzIGlzIGludGVuZGVkIGZvciBjb21tYW5kIGxpbmUgdXNlIGFuZCB3aWxsIHByb2Nlc3MuZXhpdCBpZiB0aGluZ3MgZ28gd3JvbmcuXG4gKi9cbmV4cG9ydCBjbGFzcyBQcm9qZWN0QnVpbGRlciB7XG4gICAgdW5jb25kaXRpb25hbDogYm9vbGVhbjtcbiAgICB0c0NvbnRleHQ/OiBUeXBlc2NyaXB0Q29udGV4dDtcbiAgICBncmFwaD86IEdyYXBoO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBvcHRpb25zOiBPcHRpb25zID0ge30pIHtcbiAgICAgICAgdGhpcy5ncmFwaCA9IG9wdGlvbnMuZ3JhcGg7XG4gICAgICAgIHRoaXMudW5jb25kaXRpb25hbCA9XG4gICAgICAgICAgICBvcHRpb25zLmNsZWFuIHx8IChvcHRpb25zLnRhcmdldHMgIT09IHVuZGVmaW5lZCAmJiBvcHRpb25zLnRhcmdldHM/LmluZGV4T2YoVGFyZ2V0LmNsZWFuKSAhPT0gLTEpO1xuICAgIH1cblxuICAgIGdldCBoYXNDbGVhbigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMub3B0aW9ucy5jbGVhbjtcbiAgICB9XG5cbiAgICBjbGVhckNsZWFuKCkge1xuICAgICAgICBkZWxldGUgdGhpcy5vcHRpb25zLmNsZWFuO1xuICAgIH1cblxuICAgIGhhc1RhcmdldHMoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9wdGlvbnMudGFyZ2V0cyAmJiB0aGlzLm9wdGlvbnMudGFyZ2V0cy5sZW5ndGggPiAwO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBjb25maWd1cmUocHJvamVjdDogUHJvamVjdCkge1xuICAgICAgICBpZiAoIXByb2plY3QucGtnLmhhc0NvbmZpZykge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgYXdhaXQgcHJvamVjdC5jb25maWd1cmUoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgYnVpbGQocHJvamVjdDogUHJvamVjdCkge1xuICAgICAgICBjb25zdCBwcm9ncmVzcyA9IHByb2plY3QucGtnLnN0YXJ0KFwiQnVpbGRpbmdcIik7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuI2RvQnVpbGQocHJvamVjdCwgcHJvZ3Jlc3MpO1xuICAgICAgICB9IGNhdGNoIChlOiBhbnkpIHtcbiAgICAgICAgICAgIHByb2dyZXNzLmNsb3NlKCk7XG4gICAgICAgICAgICBwcm9jZXNzLnN0ZGVyci53cml0ZShgJHtlLnN0YWNrID8/IGUubWVzc2FnZX1cXG5cXG5gKTtcbiAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHByb2dyZXNzLmNsb3NlKCk7XG4gICAgfVxuXG4gICAgYXN5bmMgI2RvQnVpbGQocHJvamVjdDogUHJvamVjdCwgcHJvZ3Jlc3M6IFByb2dyZXNzKSB7XG4gICAgICAgIGNvbnN0IHRhcmdldHMgPSB0aGlzLiNzZWxlY3RUYXJnZXRzKHByb2plY3QpO1xuXG4gICAgICAgIGlmICh0YXJnZXRzLmhhcyhUYXJnZXQuY2xlYW4pIHx8IHRoaXMub3B0aW9ucy5jbGVhbikge1xuICAgICAgICAgICAgYXdhaXQgcHJvZ3Jlc3MucnVuKFwiQ2xlYW5cIiwgKCkgPT4gcHJvamVjdC5jbGVhbigpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghdGFyZ2V0cy5oYXMoVGFyZ2V0LnR5cGVzKSAmJiAhdGFyZ2V0cy5oYXMoVGFyZ2V0LmVzbSkgJiYgIXRhcmdldHMuaGFzKFRhcmdldC5janMpKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBpbmZvOiBCdWlsZEluZm9ybWF0aW9uID0ge307XG5cbiAgICAgICAgY29uc3QgY29uZmlnID0gYXdhaXQgcHJvamVjdC5jb25maWd1cmUoKTtcblxuICAgICAgICBhd2FpdCBjb25maWc/LmJlZm9yZT8uKHsgcHJvamVjdCB9KTtcblxuICAgICAgICAvLyBJZiBhdmFpbGFibGUgd2UgdXNlIGdyYXBoIHRvIGFjY2VzcyBkZXBlbmRlbmN5IEFQSSBzaGFzXG4gICAgICAgIGNvbnN0IGdyYXBoID0gdGhpcy5ncmFwaCA/PyAoYXdhaXQgR3JhcGguZm9yUHJvamVjdChwcm9qZWN0LnBrZy5wYXRoKSk7XG4gICAgICAgIGxldCBub2RlOiBHcmFwaC5Ob2RlIHwgdW5kZWZpbmVkO1xuICAgICAgICBpZiAoZ3JhcGgpIHtcbiAgICAgICAgICAgIG5vZGUgPSBncmFwaC5nZXQocHJvamVjdC5wa2cubmFtZSk7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IGRlcCBvZiBub2RlLmRlcGVuZGVuY2llcykge1xuICAgICAgICAgICAgICAgIGlmIChkZXAuaW5mby5hcGlTaGEgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoaW5mby5kZXBlbmRlbmN5QXBpU2hhcyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpbmZvLmRlcGVuZGVuY3lBcGlTaGFzID0ge307XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaW5mby5kZXBlbmRlbmN5QXBpU2hhc1tkZXAucGtnLm5hbWVdID0gZGVwLmluZm8uYXBpU2hhO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0YXJnZXRzLmhhcyhUYXJnZXQudHlwZXMpKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIC8vIE9idGFpbiBvciBpbml0aWFsaXplIHR5cGVzY3JpcHQgc29sdXRpb24gYnVpbGRlclxuICAgICAgICAgICAgICAgIGxldCBjb250ZXh0ID0gdGhpcy50c0NvbnRleHQ7XG4gICAgICAgICAgICAgICAgaWYgKGNvbnRleHQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgICAgICBjb250ZXh0ID0gdGhpcy50c0NvbnRleHQgPSBhd2FpdCBjcmVhdGVUeXBlc2NyaXB0Q29udGV4dChwcm9qZWN0LnBrZy53b3Jrc3BhY2UsIGdyYXBoKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBjb25zdCByZWZyZXNoQ2FsbGJhY2sgPSBwcm9ncmVzcy5yZWZyZXNoLmJpbmQocHJvZ3Jlc3MpO1xuXG4gICAgICAgICAgICAgICAgaWYgKHByb2plY3QucGtnLmlzTGlicmFyeSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBhcGlTaGEgPSBjcmVhdGVIYXNoKFwic2hhMVwiKTtcblxuICAgICAgICAgICAgICAgICAgICAvLyBPdXIgQVBJIFNIQSBjaGFuZ2VzIGlmIHRoYXQgb2YgYW55IGRlcGVuZGVuY3kgY2hhbmdlc1xuICAgICAgICAgICAgICAgICAgICBpZiAobm9kZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBkZXAgb2Ygbm9kZS5kZXBlbmRlbmNpZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGVwLmluZm8uYXBpU2hhICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBpU2hhLnVwZGF0ZShkZXAuaW5mby5hcGlTaGEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHByb2dyZXNzLnJ1bihgR2VuZXJhdGUgJHtwcm9ncmVzcy5lbXBoYXNpemUoXCJ0eXBlIGRlY2xhcmF0aW9uc1wiKX1gLCBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCBjb250ZXh0LmJ1aWxkKHByb2plY3QucGtnLCBcInNyY1wiLCByZWZyZXNoQ2FsbGJhY2spO1xuICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgcHJvamVjdC5oYXNoRGVjbGFyYXRpb25zKGFwaVNoYSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIFdvcmstaW4tcHJvZ3Jlc3MgYWx0ZXJuYXRpdmUgZG9jIGdlbmVyYXRpb24gaW1wbGVtZW50YXRpb25cbiAgICAgICAgICAgICAgICAgICAgLy8gYXdhaXQgcHJvZ3Jlc3MucnVuKGBFeHRyYWN0ICR7cHJvZ3Jlc3MuZW1waGFzaXplKFwiYXBpIGRvY3NcIil9YCwgKCkgPT5cbiAgICAgICAgICAgICAgICAgICAgLy8gICAgIGVtaXRBcGlEb2MocHJvamVjdC5wa2csIHByb2dyYW0sIHByb2dyZXNzKSxcbiAgICAgICAgICAgICAgICAgICAgLy8gKTtcblxuICAgICAgICAgICAgICAgICAgICBpbmZvLmFwaVNoYSA9IGFwaVNoYS5kaWdlc3QoXCJoZXhcIik7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgcHJvZ3Jlc3MucnVuKGBWYWxpZGF0ZSAke3Byb2dyZXNzLmVtcGhhc2l6ZShcInR5cGVzXCIpfWAsICgpID0+XG4gICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0LmJ1aWxkKHByb2plY3QucGtnLCBcInNyY1wiLCByZWZyZXNoQ2FsbGJhY2ssIGZhbHNlKSxcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHByb2plY3QucGtnLmhhc1Rlc3RzKSB7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHByb2dyZXNzLnJ1bihgVmFsaWRhdGUgJHtwcm9ncmVzcy5lbXBoYXNpemUoXCJ0ZXN0IHR5cGVzXCIpfWAsICgpID0+XG4gICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0LmJ1aWxkKHByb2plY3QucGtnLCBcInRlc3RcIiwgcmVmcmVzaENhbGxiYWNrKSxcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgaWYgKGUgaW5zdGFuY2VvZiBCdWlsZEVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgIHByb2dyZXNzLmZhaWx1cmUoXCJUZXJtaW5hdGluZyBkdWUgdG8gdHlwZSBlcnJvcnNcIik7XG4gICAgICAgICAgICAgICAgICAgIHByb2Nlc3Muc3RkZXJyLndyaXRlKGAke2UuZGlhZ25vc3RpY3N9XFxuYCk7XG4gICAgICAgICAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhyb3cgZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGZvcm1hdHMgPSBBcnJheTxcImVzbVwiIHwgXCJjanNcIj4oKTtcbiAgICAgICAgaWYgKHRhcmdldHMuaGFzKFRhcmdldC5lc20pKSB7XG4gICAgICAgICAgICBmb3JtYXRzLnB1c2goXCJlc21cIik7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRhcmdldHMuaGFzKFRhcmdldC5janMpKSB7XG4gICAgICAgICAgICBmb3JtYXRzLnB1c2goXCJjanNcIik7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZm9ybWF0cy5sZW5ndGgpIHtcbiAgICAgICAgICAgIGNvbnN0IGdyb3VwcyA9IFtwcm9qZWN0LnBrZy5pc0xpYnJhcnkgPyBcImxpYnJhcnlcIiA6IFwiYXBwXCJdO1xuICAgICAgICAgICAgaWYgKHByb2plY3QucGtnLmhhc1Rlc3RzKSB7XG4gICAgICAgICAgICAgICAgZ3JvdXBzLnB1c2goXCJ0ZXN0c1wiKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgZm9ybWF0RGVzYyA9IGZvcm1hdHMubWFwKHByb2dyZXNzLmVtcGhhc2l6ZSkuam9pbihcIitcIik7XG4gICAgICAgICAgICBjb25zdCBncm91cERlc2MgPSBncm91cHMubWFwKHByb2dyZXNzLmVtcGhhc2l6ZSkuam9pbihcIitcIik7XG5cbiAgICAgICAgICAgIGF3YWl0IHByb2dyZXNzLnJ1bihgVHJhbnNwaWxlICR7Z3JvdXBEZXNjfSB0byAke2Zvcm1hdERlc2N9YCwgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICAgIGZvciAoY29uc3QgZm9ybWF0IG9mIGZvcm1hdHMpIHtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy4jdHJhbnNwaWxlKHByb2plY3QsIGZvcm1hdCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBhd2FpdCBjb25maWc/LmFmdGVyPy4oeyBwcm9qZWN0IH0pO1xuXG4gICAgICAgIC8vIE9ubHkgdXBkYXRlIGJ1aWxkIGluZm9ybWF0aW9uIHdoZW4gdGhlcmUgYXJlIG5vIGV4cGxpY2l0IHRhcmdldHMgc28gd2Uga25vdyBpdCdzIGEgZnVsbCBidWlsZFxuICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy50YXJnZXRzPy5sZW5ndGgpIHtcbiAgICAgICAgICAgIGF3YWl0IHByb2plY3QucmVjb3JkQnVpbGRJbmZvKGluZm8pO1xuICAgICAgICAgICAgaWYgKG5vZGUpIHtcbiAgICAgICAgICAgICAgICBub2RlLmluZm8gPSBpbmZvO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgI3RyYW5zcGlsZShwcm9qZWN0OiBQcm9qZWN0LCBmb3JtYXQ6IFwiZXNtXCIgfCBcImNqc1wiKSB7XG4gICAgICAgIGF3YWl0IHByb2plY3QuYnVpbGRTb3VyY2UoZm9ybWF0KTtcbiAgICAgICAgaWYgKHByb2plY3QucGtnLmhhc1Rlc3RzKSB7XG4gICAgICAgICAgICBhd2FpdCBwcm9qZWN0LmJ1aWxkVGVzdHMoZm9ybWF0KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgICNzZWxlY3RUYXJnZXRzKHByb2plY3Q6IFByb2plY3QpIHtcbiAgICAgICAgY29uc3QgdGFyZ2V0cyA9IG5ldyBTZXQ8c3RyaW5nPih0aGlzLm9wdGlvbnMudGFyZ2V0cyk7XG5cbiAgICAgICAgaWYgKCF0YXJnZXRzLnNpemUpIHtcbiAgICAgICAgICAgIHRhcmdldHMuYWRkKFRhcmdldC50eXBlcyk7XG5cbiAgICAgICAgICAgIGlmIChwcm9qZWN0LnBrZy5zdXBwb3J0c0VzbSkge1xuICAgICAgICAgICAgICAgIHRhcmdldHMuYWRkKFRhcmdldC5lc20pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocHJvamVjdC5wa2cuc3VwcG9ydHNDanMpIHtcbiAgICAgICAgICAgICAgICB0YXJnZXRzLmFkZChUYXJnZXQuY2pzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmICghcHJvamVjdC5wa2cuc3VwcG9ydHNFc20pIHtcbiAgICAgICAgICAgICAgICB0YXJnZXRzLmRlbGV0ZShUYXJnZXQuZXNtKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFwcm9qZWN0LnBrZy5zdXBwb3J0c0Nqcykge1xuICAgICAgICAgICAgICAgIHRhcmdldHMuZGVsZXRlKFRhcmdldC5janMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRhcmdldHM7XG4gICAgfVxufVxuIl0sCiAgIm1hcHBpbmdzIjogIkFBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQU1BLFNBQVMsa0JBQWtCO0FBRTNCLFNBQVMsa0JBQWtCO0FBQzNCLFNBQVMsYUFBYTtBQUV0QixTQUFTLCtCQUErQjtBQUdqQyxJQUFLLFNBQUwsa0JBQUtBLFlBQUw7QUFDSCxFQUFBQSxRQUFBLFdBQVE7QUFDUixFQUFBQSxRQUFBLFdBQVE7QUFDUixFQUFBQSxRQUFBLFNBQU07QUFDTixFQUFBQSxRQUFBLFNBQU07QUFKRSxTQUFBQTtBQUFBLEdBQUE7QUFrQkwsTUFBTSxlQUFlO0FBQUEsRUFLeEIsWUFBb0IsVUFBbUIsQ0FBQyxHQUFHO0FBQXZCO0FBQ2hCLFNBQUssUUFBUSxRQUFRO0FBQ3JCLFNBQUssZ0JBQ0QsUUFBUSxTQUFVLFFBQVEsWUFBWSxVQUFhLFFBQVEsU0FBUyxRQUFRLG1CQUFZLE1BQU07QUFBQSxFQUN0RztBQUFB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
